import{j as e}from"./index-kOaLMnvm.js";import{r as t}from"./react-vendor-DWDxyCYt.js";import{a as s}from"./redux-vendor-s9F9CGgp.js";import{L as r,a,u as n}from"./router-vendor-DJrAx8OX.js";import{s as l,c as o,C as i}from"./useLikes-BE7clvNu.js";import{e as c,X as d,a0 as m,a8 as u,c as p,a7 as h,w as f,a9 as x,a5 as g,V as b}from"./ui-vendor-LOG_mfyu.js";const j=({isOpen:s,onClose:a,commentId:n})=>{const[l,o]=t.useState([]),[i,h]=t.useState(!1),[f,x]=t.useState(null),[g,b]=t.useState(""),j=t.useCallback(async()=>{h(!0),x(null);try{const e=await fetch(`/api/comments/${n}/likes`,{credentials:"include"});if(!e.ok)throw new Error("Failed to fetch comment likes");const t=await e.json();o(t.likes||[]),b(t.comment||"")}catch(e){x("Failed to load likes. Please try again.")}finally{h(!1)}},[n]),v=t.useCallback(async()=>{try{const e=await fetch(`/api/comments/${n}`,{credentials:"include"});if(e.ok){const t=await e.json();b(t.comment||"")}}catch(e){}},[n]);t.useEffect(()=>{s&&n&&(j(),v())},[s,n,j,v]);return t.useEffect(()=>{const e=e=>{"Escape"===e.key&&a()};return s&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[s,a]),s?e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:e=>{e.target===e.currentTarget&&a()},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md max-h-[70vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(c,{size:20,className:"text-red-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Comment Likes"}),e.jsx("p",{className:"text-sm text-slate-600",children:i?"Loading...":`${l.length} ${1===l.length?"person":"people"} liked this comment`})]})]}),e.jsx("button",{onClick:a,className:"p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors",children:e.jsx(d,{size:20})})]}),g&&e.jsx("div",{className:"p-4 border-b border-slate-100 bg-slate-50",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(m,{size:16,className:"text-slate-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-slate-700 line-clamp-2",children:g.length>100?`${g.slice(0,100)}...`:g})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:i?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(u,{size:24,className:"animate-spin text-red-500"})}):f?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(c,{size:24,className:"text-red-500"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Oops! Something went wrong"}),e.jsx("p",{className:"text-slate-600 mb-4",children:f}),e.jsx("button",{onClick:j,className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Try Again"})]}):0===l.length?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(p,{size:24,className:"text-slate-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"No likes yet"}),e.jsx("p",{className:"text-slate-600",children:"Be the first to show some love for this comment!"})]}):e.jsx("div",{className:"px-6 py-4",children:e.jsx("div",{className:"space-y-3",children:l.map(t=>e.jsxs(r,{to:`/users/${t.id}`,onClick:a,className:"flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group",children:[e.jsx("img",{src:t.profileImage,alt:t.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 group-hover:border-red-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-slate-900 group-hover:text-red-600 transition-colors truncate",children:t.username}),e.jsxs("div",{className:"text-sm text-slate-600 truncate",children:[t.firstName," ",t.lastName]})]}),e.jsx("div",{className:"text-red-500 opacity-60 group-hover:opacity-100 transition-opacity",children:e.jsx(c,{size:14,fill:"currentColor"})})]},t.id))})})}),l.length>0&&!i&&e.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-slate-600",children:1===l.length?"1 person likes this comment":`${l.length} people like this comment`})})})]})}):null},v=({isOpen:c,onClose:v,postId:y,initialComments:N=[],onCommentChange:w,forceRefreshOnClose:k=!1,redirectOnClose:C})=>{const I=s(e=>e.session.user),E=t.useRef(null),L=a(),S=n(),T=t.useRef(0),A=t.useRef(0),O=t.useRef(!1),[R,z]=t.useState([]),[D,M]=t.useState(!1),[$,F]=t.useState(!1),[_,U]=t.useState(null),[P,B]=t.useState(""),[W,G]=t.useState("newest"),[H,V]=t.useState(!1),[q,J]=t.useState(""),[K,Q]=t.useState(null),[X,Y]=t.useState(""),[Z,ee]=t.useState({}),[te,se]=t.useState({isOpen:!1,commentId:null}),[re,ae]=t.useState(new Map),ne=t.useCallback(()=>{if(k)return!0;if(O.current){const e=L.pathname;return["/posts-feed","/similar-feed","/profile","/profile-feed"].some(t=>e.startsWith(t))||e.match(/^\/posts\/\d+$/)}return!1},[k,L.pathname]),le=t.useCallback((e,t)=>{O.current=!0,A.current=t,w&&w(e,t)},[w]);t.useEffect(()=>{if(c&&R.length>=0){const e=R.length;0===T.current&&(T.current=e),A.current=e}},[c,R.length]);const oe=t.useCallback(()=>{if(O.current&&w){const e=A.current;w(e>T.current?"add":"delete",e)}B(""),U(null),z([]),J(""),Q(null),Y(""),ee({}),V(!1),se({isOpen:!1,commentId:null}),v(),setTimeout(()=>{C?S(C):ne()&&window.location.reload()},100)},[v,w,ne,S,C]);t.useEffect(()=>{if(R&&R.length>0){const e=new Map;(t=>{t.forEach(t=>{e.set(t.id,{isLiked:t.isLiked||!1,likeCount:t.likes||0})})})(R),ae(e)}},[R]);const ie=t.useCallback(e=>{const t=[],s=e=>{var r;const a={id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,username:(null==(r=e.commenter)?void 0:r.username)||"Unknown User",parentId:e.parentId,created_at:e.createdAt,updated_at:e.updatedAt,commenter:e.commenter,likes:e.likes||0,isLiked:e.isLiked||!1};t.push(a),e.replies&&e.replies.length>0&&e.replies.forEach(s)};return e.forEach(s),t},[]),ce=t.useCallback(e=>{if(!e||0===e.length)return[];const t=new Map,s=[];return e.forEach(e=>{let s;s=e.commenter?{id:e.commenter.id,username:e.commenter.username,firstName:e.commenter.firstName||"",lastName:e.commenter.lastName||"",profileImage:e.commenter.profileImage||"/default-avatar.png"}:I&&e.userId===I.id?{id:I.id,username:I.username,firstName:I.firstName||"",lastName:I.lastName||"",profileImage:I.profileImage||"/default-avatar.png"}:{id:e.userId,username:e.username||"Unknown User",firstName:"",lastName:"",profileImage:"/default-avatar.png"};const r=re.get(e.id),a=(null==r?void 0:r.likeCount)??e.likes??0,n=(null==r?void 0:r.isLiked)??e.isLiked??!1,l={id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,parentId:e.parentId,createdAt:e.created_at,updatedAt:e.updated_at,commenter:s,replies:[],likes:a,isLiked:n};t.set(e.id,l)}),e.forEach(e=>{const r=t.get(e.id);if(null===e.parentId||void 0===e.parentId)s.push(r),r.replies=[];else{const a=t.get(e.parentId);a?(a.replies||(a.replies=[]),a.replies.push(r)):s.push(r)}}),s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),s.forEach(e=>{e.replies&&e.replies.length>0&&e.replies.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime())}),s},[I,re]),de=t.useMemo(()=>{if(R&&R.length>0){return ce(R)}return[]},[R,ce]),me=t.useMemo(()=>{let e=[...de];return P.trim()&&(e=l(e,P)),e.sort((e,t)=>{var s,r;switch(W){case"oldest":return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime();case"popular":{const a=e.likes||0,n=t.likes||0;if(a!==n)return n-a;const l=(null==(s=e.replies)?void 0:s.length)||0,o=(null==(r=t.replies)?void 0:r.length)||0;return l!==o?o-l:new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()}default:return new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()}}),e},[de,P,W]),ue=t.useCallback(async()=>{if(y){M(!0),U(null);try{const e=await fetch(`/api/posts/${y}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=(await e.json()).postComments||[];z(t),V(!0)}catch(e){U(e instanceof Error?e.message:"Failed to load comments")}finally{M(!1)}}},[y]);t.useEffect(()=>{if(!c||!y)return z([]),U(null),J(""),Q(null),Y(""),ee({}),B(""),V(!1),se({isOpen:!1,commentId:null}),T.current=0,A.current=0,void(O.current=!1);if(U(null),J(""),Q(null),Y(""),ee({}),N&&N.length>0){if(N.some(e=>e.replies&&e.replies.length>0)){const e=ie(N);z(e),V(!0)}else{const e=N.map(e=>{var t;return{id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,username:(null==(t=e.commenter)?void 0:t.username)||"Unknown User",parentId:e.parentId,created_at:e.createdAt,updated_at:e.updatedAt,commenter:e.commenter,likes:e.likes||0,isLiked:e.isLiked||!1}});z(e),V(!0)}ue()}else ue()},[c,y,N,ue,ie]);const pe=t.useCallback(e=>{const t=new Date,s=new Date(e),r=Math.floor((t.getTime()-s.getTime())/36e5);if(r<1)return"just now";if(r<24)return`${r}h ago`;const a=Math.floor(r/24);return a<7?`${a}d ago`:s.toLocaleDateString()},[]),he=t.useCallback(async()=>{if(I&&q.trim()){F(!0);try{const e=await o.createComment({comment:q.trim(),postId:y}),t={id:e.comment.id,userId:I.id,postId:y,comment:q.trim(),username:I.username,parentId:null,created_at:e.comment.createdAt,updated_at:e.comment.updatedAt,commenter:{id:I.id,username:I.username,firstName:I.firstName||"",lastName:I.lastName||"",profileImage:I.profileImage||"/default-avatar.png"},likes:0,isLiked:!1};ae(e=>{const s=new Map(e);return s.set(t.id,{isLiked:!1,likeCount:0}),s}),z(e=>{const s=[t,...e];return le("add",s.length),s}),J("")}catch(e){U("Failed to add comment")}finally{F(!1)}}},[I,q,y,le]),fe=t.useCallback(e=>{for(const t of de){if(t.id===e)return t;if(t.replies)for(const s of t.replies)if(s.id===e)return s}return null},[de]),xe=t.useCallback(async e=>{var t;if(I&&X.trim()){F(!0);try{const s=fe(e),r=(null==(t=null==s?void 0:s.commenter)?void 0:t.username)||"",a=await o.createReply({comment:X.trim(),postId:y,parentId:e,replyToUsername:r}),n={id:a.comment.id,userId:I.id,postId:y,comment:X.trim(),username:I.username,parentId:e,created_at:a.comment.createdAt,updated_at:a.comment.updatedAt,commenter:{id:I.id,username:I.username,firstName:I.firstName||"",lastName:I.lastName||"",profileImage:I.profileImage||"/default-avatar.png"},likes:0,isLiked:!1};ae(e=>{const t=new Map(e);return t.set(n.id,{isLiked:!1,likeCount:0}),t}),z(e=>{const t=[...e,n];return le("add",t.length),t}),Y(""),Q(null)}catch(s){U("Failed to add reply")}finally{F(!1)}}},[I,X,y,fe,le]),ge=async(e,t)=>{try{await o.updateComment(e,t),z(s=>s.map(s=>s.id===e?{...s,comment:t}:s))}catch(s){throw s}},be=async e=>{try{await o.deleteComment(y,e),z(t=>{const s=t.filter(t=>t.id!==e&&t.parentId!==e);return le("delete",s.length),s})}catch(t){throw t}},je=t.useCallback(async(e,t,s)=>{void 0!==t&&void 0!==s&&(ae(r=>{const a=new Map(r);return a.set(e,{isLiked:t,likeCount:s}),a}),z(r=>r.map(r=>r.id===e?{...r,likes:s,isLiked:t}:r)))},[]),ve=t.useCallback(e=>{se({isOpen:!0,commentId:e})},[]),ye=t.useCallback(()=>{se({isOpen:!1,commentId:null})},[]),Ne=t.useCallback(e=>{ee(t=>({...t,[e]:!t[e]}))},[]),we=t.useCallback(()=>{V(!1),ue()},[ue]),ke=t.useCallback(e=>{E.current&&!E.current.contains(e.target)&&oe()},[oe]);if(t.useEffect(()=>{const e=e=>{"Escape"===e.key&&oe()};return c&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[c,oe]),!c)return null;const Ce=R.length,Ie=me.length,Ee=D&&!H;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:ke,children:e.jsxs("div",{ref:E,className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-orange-500 to-slate-600 rounded-full flex items-center justify-center",children:e.jsx(m,{className:"text-white",size:20})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Comments"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[Ce," ",1===Ce?"comment":"comments",P&&Ie!==Ce&&e.jsxs("span",{children:[" â€¢ ",Ie," shown"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:we,disabled:D,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:"Refresh comments",children:e.jsx(h,{size:18,className:D?"animate-spin":""})}),e.jsx("button",{onClick:oe,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(d,{size:18})})]})]}),e.jsxs("div",{className:"p-4 border-b border-gray-100 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),e.jsx("input",{type:"text",placeholder:"Search comments...",value:P,onChange:e=>B(e.target.value),className:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{size:16,className:"text-gray-500"}),e.jsxs("select",{value:W,onChange:e=>G(e.target.value),className:"border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"newest",children:"Newest first"}),e.jsx("option",{value:"oldest",children:"Oldest first"}),e.jsx("option",{value:"popular",children:"Most popular"})]})]})]}),I&&e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(r,{to:`/users/${I.id}`,className:"flex-shrink-0",children:e.jsx("img",{src:I.profileImage||"/default-avatar.png",alt:I.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}})}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:q,onChange:e=>J(e.target.value),placeholder:"Write a comment...",className:"w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none",rows:3,disabled:$}),e.jsx("button",{onClick:he,disabled:!q.trim()||$,className:"absolute bottom-3 right-3 p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:$?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(g,{size:16})})]})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[_&&e.jsxs("div",{className:"p-4 m-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700",children:[e.jsx(b,{size:16}),e.jsx("span",{children:_}),e.jsx("button",{onClick:we,className:"ml-auto text-red-600 hover:text-red-800 font-medium",children:"Retry"})]}),Ee?e.jsx("div",{className:"p-8 text-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 text-gray-600",children:[e.jsx(u,{className:"animate-spin",size:20}),"Loading comments..."]})}):0===me.length?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(m,{className:"text-gray-400",size:24})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:P?"No comments found":"No comments yet"}),e.jsx("p",{className:"text-gray-600 mb-4",children:P?"Try adjusting your search terms":"Be the first to share your thoughts!"}),P&&e.jsx("button",{onClick:()=>B(""),className:"text-orange-600 hover:text-orange-700 font-medium",children:"Clear search"})]}):e.jsx("div",{className:"p-4 space-y-6",children:me.map(t=>e.jsx(i,{comment:t,depth:0,maxDepth:5,sessionUser:I,postUser:void 0,allComments:me,replyToComment:K,setReplyToComment:Q,replyText:X,setReplyText:Y,handleAddReply:xe,isSubmitting:$,formatTimeAgo:pe,showAllReplies:Z,toggleShowAllReplies:Ne,onEdit:ge,onDelete:be,onLikeToggle:je,onShowLikes:ve},t.id))})]}),e.jsx("div",{className:"p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl",children:e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(p,{size:14}),Ce," ",1===Ce?"participant":"participants"]})}),!I&&e.jsx("div",{className:"text-right",children:e.jsxs("span",{children:[e.jsx("a",{href:"/login",className:"text-orange-600 hover:text-orange-700 font-medium",children:"Sign in"})," ","to join the conversation"]})})]})})]})}),te.isOpen&&te.commentId&&e.jsx(j,{isOpen:te.isOpen,onClose:ye,commentId:te.commentId,initialCount:0})]})},y=(e={})=>{const{initialComments:s=[],forceRefreshOnClose:r=!1,redirectOnClose:l,refreshDelay:i=100}=e,c=a(),d=n(),[m,u]=t.useState({isOpen:!1,postId:null,comments:s,isLoading:!1,error:null,page:1,hasMore:!0}),[p,h]=t.useState(s),[f,x]=t.useState(!1),[g,b]=t.useState(null),j=t.useRef(!1),v=t.useRef(null),y=t.useRef(null),N=t.useRef(0),w=t.useRef(!1),k=t.useCallback(()=>{if(r)return!0;if(!w.current)return!1;const e=c.pathname;return["/posts-feed","/similar-feed","/profile","/profile-feed"].some(t=>e.startsWith(t))||e.match(/^\/posts\/\d+$/)},[r,c.pathname]),C=t.useCallback(()=>{setTimeout(()=>{l?d(l):window.location.reload()},i)},[d,l,i]),I=t.useCallback(()=>{b(null),u(e=>({...e,error:null}))},[]),E=t.useCallback(e=>e.reduce((e,t)=>{let s=1;return t.replies&&t.replies.length>0&&(s+=E(t.replies)),e+s},0),[]);t.useEffect(()=>{if(m.isOpen&&m.postId&&y.current){const e=E(m.comments);e!==N.current&&(w.current=!0,y.current(m.postId,e))}},[m.comments,m.isOpen,m.postId,E]);const L=t.useCallback(async(e,t=1)=>{if(j.current)return[];j.current=!0,x(!0),I();try{const s=await o.getPostComments(e,{page:t,perPage:20,includeReplies:!0,includeLikes:!1}),r=s.comments||[];return 1===t?(h(r),u(e=>{var t;return{...e,comments:r,page:2,hasMore:(null==(t=s.pagination)?void 0:t.hasNext)||!1}})):(h(e=>[...e,...r]),u(e=>{var a;return{...e,comments:[...e.comments,...r],page:t+1,hasMore:(null==(a=s.pagination)?void 0:a.hasNext)||!1}})),v.current=e,r}catch(s){const e=s instanceof Error?s.message:"Failed to load comments";throw b(e),u(t=>({...t,error:e})),s}finally{x(!1),j.current=!1,u(e=>({...e,isLoading:!1}))}},[I]),S=t.useCallback(async()=>{v.current&&await L(v.current,1)},[L]),T=t.useCallback((e,t,s)=>{const r=t||[],a=E(r);N.current=a,y.current=s||null,w.current=!1,u(t=>({...t,isOpen:!0,postId:e,comments:r,page:1,hasMore:!0,error:null})),r.length>0&&h(r),t&&0!==t.length||L(e,1)},[L,E]),A=t.useCallback(()=>{if(m.isOpen&&m.postId&&y.current&&w.current){const e=E(m.comments);y.current(m.postId,e)}u(e=>({...e,isOpen:!1,postId:null,error:null})),k()&&C(),y.current=null,N.current=0,w.current=!1},[m.isOpen,m.postId,m.comments,E,k,C]),O=t.useCallback(async e=>{try{const t=(e.parentId?await o.createReply(e):await o.createComment(e)).comment;return w.current=!0,h(e=>[t,...e]),u(e=>({...e,comments:[t,...e.comments]})),t}catch(t){const e=t instanceof Error?t.message:"Failed to add comment";throw b(e),t}},[]),R=t.useCallback(async(e,t)=>{try{await o.updateComment(e,t),w.current=!0;const s=r=>r.map(r=>r.id===e?{...r,comment:t,updatedAt:(new Date).toISOString()}:r.replies?{...r,replies:s(r.replies)}:r);h(e=>s(e)),u(e=>({...e,comments:s(e.comments)}))}catch(s){const e=s instanceof Error?s.message:"Failed to edit comment";throw b(e),s}},[]),z=t.useCallback(async e=>{if(!m.postId)throw new Error("No post ID available");try{await o.deleteComment(m.postId,e),w.current=!0;const t=s=>s.filter(s=>s.id!==e&&(s.replies&&(s.replies=t(s.replies)),!0));h(e=>t(e)),u(e=>({...e,comments:t(e.comments)}))}catch(t){const e=t instanceof Error?t.message:"Failed to delete comment";throw b(e),t}},[m.postId]),D=t.useCallback(()=>E(p),[p,E]),M=t.useCallback(e=>{const t=s=>{for(const r of s){if(r.id===e)return r;if(r.replies){const e=t(r.replies);if(e)return e}}};return t(p)},[p]);return{modal:m,comments:p,isLoading:f,error:g,openModal:T,closeModal:A,addComment:O,editComment:R,deleteComment:z,loadComments:L,refreshComments:S,getCommentCount:D,getCommentById:M,clearError:I,forceRefresh:C,hasChanges:w.current}};export{v as C,y as u};
