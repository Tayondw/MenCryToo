var e=Object.defineProperty,t=(t,s,n)=>((t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n)(t,"symbol"!=typeof s?s+"":s,n);import{j as s}from"./index-kOaLMnvm.js";import{r as n}from"./react-vendor-DWDxyCYt.js";import{e as a,X as r,a8 as i,c as l,aa as o,a5 as c,ab as d,f as m,s as u,a6 as p,a3 as h,I as x,a0 as g}from"./ui-vendor-LOG_mfyu.js";import{L as f}from"./router-vendor-DJrAx8OX.js";const b=({size:e=24,className:t="",color:n="currentColor"})=>s.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:n,className:t,xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",fill:n})}),j=({postId:e,initialLikeCount:t,initialIsLiked:r=!1,onLikeToggle:i,onLikesClick:l,className:o="",showCount:c=!0,size:d=18,disabled:m=!1})=>{const[u,p]=n.useState(r),[h,x]=n.useState(t),[g,f]=n.useState(!1);n.useEffect(()=>{p(r),x(t)},[r,t]);return s.jsxs("div",{className:`flex items-center gap-2 ${o}`,children:[s.jsx("button",{onClick:async()=>{if(m||g)return;const t=!u,s=t?h+1:h-1;p(t),x(s),f(!0);try{const t=await fetch(`/api/posts/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to toggle like");const s=await t.json();p(s.isLiked),x(s.likeCount),i&&i(e,s.isLiked,s.likeCount)}catch(n){p(u),x(h)}finally{f(!1)}},disabled:m||g,className:`flex items-center gap-1 transition-all duration-200 ${u?"text-red-500 hover:text-red-600":"text-slate-500 hover:text-red-500"} ${m||g?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${g?"animate-pulse":""} group`,"aria-label":u?"Unlike post":"Like post",children:u?s.jsx(b,{size:d,className:"transition-transform group-hover:scale-110"}):s.jsx(a,{size:d,className:"transition-transform group-hover:scale-110"})}),c&&s.jsx("button",{onClick:()=>{l&&h>0&&l(e)},className:"text-sm font-medium transition-colors "+(h>0?"text-slate-700 hover:text-orange-600 cursor-pointer":"text-slate-500 cursor-default"),disabled:0===h,"aria-label":`${h} likes`,children:h.toLocaleString()})]})},y=({isOpen:e,onClose:t,postId:o})=>{const[c,d]=n.useState([]),[m,u]=n.useState(!1),[p,h]=n.useState(null),x=n.useCallback(async()=>{u(!0),h(null);try{const e=await fetch(`/api/posts/${o}/likes`);if(!e.ok)throw new Error("Failed to fetch likes");const t=await e.json();d(t.likes||[])}catch(e){h("Failed to load likes. Please try again.")}finally{u(!1)}},[o]);n.useEffect(()=>{e&&o&&x()},[e,o,x]);return n.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",s),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",s),document.body.style.overflow="unset"}},[e,t]),e?s.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:e=>{e.target===e.currentTarget&&t()},children:s.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md max-h-[70vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(a,{size:20,className:"text-red-500"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:"Likes"}),s.jsx("p",{className:"text-sm text-slate-600",children:m?"Loading...":`${c.length} ${1===c.length?"person":"people"} liked this post`})]})]}),s.jsx("button",{onClick:t,className:"p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors",children:s.jsx(r,{size:20})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:m?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsx(i,{size:24,className:"animate-spin text-orange-500"})}):p?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(a,{size:24,className:"text-red-500"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Oops! Something went wrong"}),s.jsx("p",{className:"text-slate-600 mb-4",children:p}),s.jsx("button",{onClick:x,className:"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors",children:"Try Again"})]}):0===c.length?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(l,{size:24,className:"text-slate-400"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"No likes yet"}),s.jsx("p",{className:"text-slate-600",children:"Be the first to show some love for this post!"})]}):s.jsx("div",{className:"px-6 py-4",children:s.jsx("div",{className:"space-y-3",children:c.map(e=>s.jsxs(f,{to:`/users/${e.id}`,onClick:t,className:"flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group",children:[s.jsx("img",{src:e.profileImage,alt:e.username,className:"w-12 h-12 rounded-full object-cover border-2 border-slate-200 group-hover:border-orange-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-semibold text-slate-900 group-hover:text-orange-600 transition-colors truncate",children:e.username}),s.jsxs("div",{className:"text-sm text-slate-600 truncate",children:[e.firstName," ",e.lastName]})]}),s.jsx("div",{className:"text-red-500 opacity-60 group-hover:opacity-100 transition-opacity",children:s.jsx(a,{size:16,fill:"currentColor"})})]},e.id))})})}),c.length>0&&!m&&s.jsx("div",{className:"p-6 border-t border-slate-200 bg-slate-50",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-sm text-slate-600",children:1===c.length?"1 person likes this post":`${c.length} people like this post`})})})]})}):null};function v(e,t){const s=t.toLowerCase().trim();if(!s)return e;const n=e=>{var t;const a=(e=>{const t=e.comment.toLowerCase().includes(s),n=e.commenter.username.toLowerCase().includes(s),a=e.commenter.firstName.toLowerCase().includes(s),r=e.commenter.lastName.toLowerCase().includes(s);return t||n||a||r})(e),r=(null==(t=e.replies)?void 0:t.map(n).filter(Boolean))||[];return a||r.length>0?{...e,replies:r}:null};return e.map(n).filter(Boolean)}const k=({postId:e,parentId:t=null,replyToUsername:a,onSubmit:i,onCancel:l,placeholder:d="Write a comment...",autoFocus:m=!1,isSubmitting:u=!1})=>{const[p,h]=n.useState(""),[x,g]=n.useState(null),f=n.useRef(null);n.useEffect(()=>{m&&f.current&&f.current.focus()},[m]),n.useEffect(()=>{f.current&&(f.current.style.height="auto",f.current.style.height=`${f.current.scrollHeight}px`)},[p]);const b=async s=>{s.preventDefault(),g(null);const n=function(e){const t=e.trim();return t?t.length<1?{isValid:!1,error:"Comment is too short"}:t.length>500?{isValid:!1,error:"Comment is too long (max 500 characters)"}:{isValid:!0}:{isValid:!1,error:"Comment cannot be empty"}}(p);if(n.isValid)try{await i({comment:p.trim(),postId:e,parentId:t,replyToUsername:a}),h(""),g(null)}catch(r){g(r instanceof Error?r.message:"Failed to post comment")}else g(n.error||"Invalid comment")},j=null!==t&&a,y=j?"Reply":"Comment",v=p.length,k=v>400,w=v>500;return s.jsxs("form",{onSubmit:b,className:"space-y-3",children:[j&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg",children:[s.jsx(o,{size:14}),s.jsxs("span",{children:["Replying to ",s.jsxs("span",{className:"font-medium",children:["@",a]})]}),l&&s.jsx("button",{type:"button",onClick:l,className:"ml-auto text-gray-400 hover:text-gray-600 transition-colors",children:s.jsx(r,{size:14})})]}),s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{ref:f,value:p,onChange:e=>{h(e.target.value),x&&g(null)},onKeyDown:e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),b(e)),"Escape"===e.key&&l&&(e.preventDefault(),l())},placeholder:d,disabled:u,className:`\n            w-full px-4 py-3 pr-12 border rounded-lg resize-none transition-all duration-200\n            min-h-[80px] max-h-[200px]\n            ${x?"border-red-300 focus:border-red-500 focus:ring-red-200":"border-gray-300 focus:border-orange-500 focus:ring-orange-200"}\n            ${u?"bg-gray-50 cursor-not-allowed":"bg-white"}\n            focus:ring-2 focus:outline-none\n          `,rows:3}),s.jsx("button",{type:"submit",disabled:!p.trim()||u||w,className:`\n            absolute bottom-3 right-3 p-2 rounded-full transition-all duration-200\n            ${!p.trim()||w||u?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 shadow-md hover:shadow-lg"}\n          `,title:`${y} (⌘+Enter)`,children:u?s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):s.jsx(c,{size:16})})]}),s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("div",{className:"flex-1",children:x&&s.jsx("span",{className:"text-red-600 font-medium",children:x})}),s.jsxs("div",{className:`\n          font-medium transition-colors\n          ${w?"text-red-600":k?"text-orange-600":"text-gray-400"}\n        `,children:[v,"/",500]})]}),j&&s.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[l&&s.jsx("button",{type:"button",onClick:l,disabled:u,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:!p.trim()||u||w,className:`\n              px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200\n              ${!p.trim()||w||u?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 shadow-md hover:shadow-lg"}\n            `,children:u?"Posting...":y})]}),s.jsxs("div",{className:"text-xs text-gray-400 text-right",children:[s.jsx("span",{children:"⌘+Enter to post"}),l&&s.jsx("span",{children:" • Esc to cancel"})]})]})},w=({commentId:e,initialLikeCount:t,initialIsLiked:r=!1,onLikeToggle:i,onLikesClick:l,className:o="",showCount:c=!0,size:d=14,disabled:m=!1})=>{const[u,p]=n.useState(r),[h,x]=n.useState(t),[g,f]=n.useState(!1);n.useEffect(()=>{p(r),x(t)},[r,t,e]),n.useEffect(()=>{0!==t||r||(async()=>{try{const t=await fetch(`/api/comments/${e}/like-status`,{credentials:"include"});if(t.ok){const e=await t.json();p(e.isLiked),x(e.likeCount)}}catch(t){}})()},[e,t,r]);const j=n.useCallback(async()=>{if(m||g)return;const t=!u,s=t?h+1:Math.max(0,h-1);p(t),x(s),f(!0);try{const t=await fetch(`/api/comments/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const s=await t.json();s.success?(p(s.isLiked),x(s.likeCount),i&&i(e,s.isLiked,s.likeCount)):(p(u),x(h))}catch(n){p(u),x(h)}finally{f(!1)}},[e,m,g,u,h,i]),y=n.useCallback(t=>{t.stopPropagation(),l&&h>0&&l(e)},[l,e,h]),v=n.useCallback(e=>{e.stopPropagation(),j()},[j]);return s.jsxs("div",{className:`flex items-center gap-1 ${o}`,children:[s.jsx("button",{onClick:v,disabled:m||g,className:`flex items-center transition-all duration-200 ${u?"text-red-500 hover:text-red-600":"text-slate-400 hover:text-red-500"} ${m||g?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${g?"animate-pulse":""} group`,"aria-label":u?"Unlike comment":"Like comment",title:u?"Unlike comment":"Like comment",children:u?s.jsx(b,{size:d,className:"transition-transform group-hover:scale-110",color:"currentColor"}):s.jsx(a,{size:d,className:"transition-transform group-hover:scale-110",fill:"none"})}),(c||h>0)&&h>0&&s.jsx("button",{onClick:y,className:"text-xs font-medium transition-colors text-slate-600 hover:text-red-500 cursor-pointer",disabled:0===h,"aria-label":`${h} likes`,title:`${h} ${1===h?"like":"likes"}`,children:h.toLocaleString()}),g&&s.jsx("div",{className:"w-3 h-3 border border-red-300 border-t-red-500 rounded-full animate-spin ml-1"})]})},N=({comment:e,depth:t=0,maxDepth:a=5,sessionUser:r,postUser:i,allComments:l=[],replyToComment:c,setReplyToComment:b,replyText:j="",setReplyText:y,isSubmitting:v=!1,showAllReplies:C={},toggleShowAllReplies:$,onReply:L,onEdit:S,onDelete:T,handleAddReply:E,onLikeToggle:I,onShowLikes:R,formatTimeAgo:z,currentUserId:U})=>{var P,D,A,F,M,O,V,_,G,B;const[H,J]=n.useState(!1),[K,Y]=n.useState(!1),[q,W]=n.useState(e.comment),[Q,X]=n.useState(!0),[Z,ee]=n.useState(!1),[te,se]=n.useState(!1),[ne,ae]=n.useState(e.likes||0),[re,ie]=n.useState(e.isLiked||!1),le=!!(r&&b&&E),oe=U||(null==r?void 0:r.id),ce=function(e,t){return void 0!==t&&e.userId===t}(e,oe),de=e.replies&&e.replies.length>0,me=t<a,ue=function(e){const t=e.match(/^@(\w+)/);return t?t[1]:null}(e.comment),pe=le?0:2,he=e.replies&&e.replies.length>pe,xe=(null==C?void 0:C[e.id])??te,ge=xe?e.replies:null==(P=e.replies)?void 0:P.slice(0,pe);n.useEffect(()=>{},[e.id,e.likes,e.isLiked,ne,re]);const fe=n.useCallback(e=>{if(0===e)return"";switch(e){case 1:return"ml-12";case 2:return"ml-16";case 3:return"ml-20";default:return"ml-24"}},[]),be=n.useMemo(()=>e.commenter?{id:e.commenter.id,username:e.commenter.username||"Unknown User",firstName:e.commenter.firstName||"",lastName:e.commenter.lastName||"",profileImage:e.commenter.profileImage||"/default-avatar.png"}:{id:e.userId,username:"Unknown User",firstName:"",lastName:"",profileImage:"/default-avatar.png"},[e.commenter,e.userId]),je=n.useCallback(e=>{if(!le||!i||!l.length){const t=/@([\w-]+)/g;return e.split(t).map((e,t)=>t%2==1?s.jsxs("span",{className:"text-orange-600 font-medium",children:["@",e]},t):e)}const t=/@([\w-]+)/g,n=[];let a,o=0;for(;null!==(a=t.exec(e));){a.index>o&&n.push(e.slice(o,a.index));const t=a[1];let c=null;if(r&&t===r.username)c=r.id;else if(t===i.username)c=i.id;else{const e=s=>{var n;for(const a of s){if((null==(n=a.commenter)?void 0:n.username)===t)return a.commenter.id;if(a.replies){const t=e(a.replies);if(t)return t}}return null};c=e(l)}n.push(s.jsxs(f,{to:`/users/${c||t}`,className:"text-orange-600 hover:text-orange-700 font-medium",children:["@",t]},`mention-${a.index}`)),o=a.index+a[0].length}return o<e.length&&n.push(e.slice(o)),0===n.length?e:n},[le,i,l,r]);n.useEffect(()=>{void 0!==e.likes&&ae(e.likes),void 0!==e.isLiked&&ie(e.isLiked)},[e.likes,e.isLiked,e.id,re,ne]);const ye=n.useCallback(async(t,s,n)=>{t===e.id&&void 0!==s&&void 0!==n&&(ie(s),ae(n),I&&I(t,s,n))},[e.id,I]),ve=n.useCallback(e=>{R&&R(e)},[R]),ke=()=>{$?$(e.id):se(!te)},we=()=>z?z(e.createdAt):function(e){const t=new Date,s=new Date(e),n=Math.floor((t.getTime()-s.getTime())/1e3);if(n<10)return"just now";if(n<60)return`${n}s ago`;const a=Math.floor(n/60);if(a<60)return`${a}m ago`;const r=Math.floor(a/60);if(r<24)return`${r}h ago`;const i=Math.floor(r/24);if(i<7)return`${i}d ago`;const l=Math.floor(i/7);return l<4?`${l}w ago`:s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:s.getFullYear()!==t.getFullYear()?"numeric":void 0})}(e.createdAt);return s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:`flex gap-3 ${t>0?fe(t):""} ${le?"":"group"}`,children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx(f,{to:`/users/${be.id}`,children:s.jsx("img",{src:be.profileImage,alt:be.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{const t=e.target;"/default-avatar.png"!==t.src&&(t.src="/default-avatar.png")}})})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[le?s.jsxs("div",{className:"bg-slate-50 rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx(f,{to:`/users/${be.id}`,className:"font-semibold text-slate-900 text-sm hover:text-orange-600 transition-colors",children:be.firstName&&be.lastName?`${be.firstName} ${be.lastName}`:be.username}),s.jsx("span",{className:"text-xs text-slate-500",children:we()})]}),s.jsx("div",{className:"text-slate-700 text-sm mb-2",children:je(e.comment)}),s.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[r&&s.jsx(w,{commentId:e.id,initialLikeCount:ne,initialIsLiked:re,onLikeToggle:ye,onLikesClick:ve,size:12,showCount:!0}),r&&s.jsxs("button",{onClick:()=>{b&&y&&(b(e.id),j.includes(`@${be.username}`)||y(`@${be.username} `))},className:"flex items-center gap-1 hover:text-orange-600 transition-colors",children:[s.jsx(d,{size:12}),"Reply"]}),de&&s.jsxs("button",{onClick:()=>X(!Q),className:"flex items-center gap-1 hover:text-blue-500 transition-colors",children:[Q?s.jsx(m,{size:12}):s.jsx(u,{size:12}),null==(D=e.replies)?void 0:D.length," ",1===(null==(A=e.replies)?void 0:A.length)?"reply":"replies"]})]})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("span",{className:"font-semibold text-gray-900 text-sm",children:[be.firstName," ",be.lastName]}),s.jsxs("span",{className:"text-gray-500 text-sm",children:["@",be.username]}),s.jsx("span",{className:"text-gray-400 text-xs",children:we()}),ce&&s.jsxs("div",{className:"relative ml-auto opacity-0 group-hover:opacity-100 transition-opacity",children:[s.jsx("button",{onClick:()=>ee(!Z),className:"p-1 hover:bg-gray-100 rounded-full transition-colors",children:s.jsx(p,{size:14})}),Z&&s.jsxs("div",{className:"absolute right-0 top-6 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-10 min-w-[120px]",children:[s.jsxs("button",{onClick:()=>{Y(!0),ee(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[s.jsx(h,{size:14}),"Edit"]}),s.jsxs("button",{onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{await(null==T?void 0:T(e.id))}catch(t){}ee(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50",children:[s.jsx(x,{size:14}),"Delete"]})]})]})]}),s.jsx("div",{className:"mb-2",children:K?s.jsxs("div",{className:"space-y-2",children:[s.jsx("textarea",{value:q,onChange:e=>W(e.target.value),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none",rows:2,autoFocus:!0}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:async()=>{if(q.trim()!==e.comment)try{await(null==S?void 0:S(e.id,q.trim())),Y(!1)}catch(t){W(e.comment)}else Y(!1)},disabled:!q.trim(),className:"px-3 py-1 bg-orange-500 text-white text-sm rounded-lg hover:bg-orange-600 disabled:bg-gray-300",children:"Save"}),s.jsx("button",{onClick:()=>{Y(!1),W(e.comment)},className:"px-3 py-1 text-gray-600 text-sm hover:text-gray-800",children:"Cancel"})]})]}):s.jsxs("div",{className:"text-gray-800 text-sm leading-relaxed",children:[ue&&s.jsxs("span",{className:"inline-flex items-center gap-1 text-orange-600 font-medium mr-1",children:[s.jsx(o,{size:12}),ue]}),s.jsx("span",{children:ue?e.comment.replace(`@${ue}`,"").trim():e.comment})]})})]}),!K&&!le&&s.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[r&&s.jsx(w,{commentId:e.id,initialLikeCount:ne,initialIsLiked:re,onLikeToggle:ye,onLikesClick:ve,size:12,showCount:!0}),r&&s.jsxs("button",{onClick:()=>J(!0),className:"flex items-center gap-1 hover:text-orange-600 transition-colors",children:[s.jsx(d,{size:12}),"Reply"]}),de&&s.jsxs("button",{onClick:()=>X(!Q),className:"flex items-center gap-1 hover:text-blue-500 transition-colors",children:[Q?s.jsx(m,{size:12}):s.jsx(u,{size:12}),null==(F=e.replies)?void 0:F.length," ",1===(null==(M=e.replies)?void 0:M.length)?"reply":"replies"]})]}),H&&!le&&s.jsx("div",{className:"mt-3",children:s.jsx(k,{postId:e.postId,parentId:e.id,replyToUsername:null==(O=e.commenter)?void 0:O.username,onSubmit:async()=>{var t;try{await(null==L?void 0:L(e.id,(null==(t=e.commenter)?void 0:t.username)||"")),J(!1)}catch(s){throw s}},onCancel:()=>J(!1),placeholder:`Reply to @${null==(V=e.commenter)?void 0:V.username}...`,autoFocus:!0})}),c===e.id&&le&&r&&y&&s.jsxs("div",{className:`flex gap-3 mt-3 ${fe(1)}`,children:[s.jsx(f,{to:`/users/${r.id}`,className:"flex-shrink-0",children:s.jsx("img",{src:r.profileImage||"/default-avatar.png",alt:r.username,className:"w-8 h-8 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{const t=e.target;"/default-avatar.png"!==t.src&&(t.src="/default-avatar.png")}})}),s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{value:j,onChange:e=>y(e.target.value),placeholder:`Reply to @${be.username}...`,className:"w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none text-sm",rows:2,onFocus:()=>{j.includes(`@${be.username}`)||y(`@${be.username} `)}}),s.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.jsx("button",{onClick:()=>{b(null),y("")},className:"text-xs text-slate-500 hover:text-slate-700",children:"Cancel"}),s.jsx("button",{onClick:()=>{let t=j.trim();t.includes(`@${be.username}`)||(t=`@${be.username} ${t}`),y(t),null==E||E(e.id)},disabled:!j.trim()||v,className:"px-3 py-1 bg-orange-500 text-white text-xs rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:v?"Posting...":"Reply"})]})]})})]}),de&&(Q||le)&&me&&s.jsxs("div",{className:"mt-3 space-y-3",children:[null==ge?void 0:ge.map(e=>s.jsx(N,{comment:e,depth:t+1,maxDepth:a,sessionUser:r,postUser:i,allComments:l,replyToComment:c,setReplyToComment:b,replyText:j,setReplyText:y,isSubmitting:v,showAllReplies:C,toggleShowAllReplies:$,onReply:L,onEdit:S,onDelete:T,handleAddReply:E,onLikeToggle:I,onShowLikes:R,formatTimeAgo:z,currentUserId:U},e.id)),he&&s.jsx("div",{className:le?fe(t+1):"mt-2",children:xe?s.jsx("button",{onClick:ke,className:"text-sm text-slate-600 hover:text-slate-700 font-medium",children:"Show less"}):s.jsxs("button",{onClick:ke,className:"text-sm text-orange-600 hover:text-orange-700 font-medium",children:["View ",e.replies.length-pe," more replies"]})})]}),de&&(Q||le)&&!me&&!le&&s.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:[s.jsxs("div",{className:"text-xs text-gray-600 mb-2 flex items-center gap-1",children:[s.jsx(g,{size:12}),null==(_=e.replies)?void 0:_.length," more"," ",1===(null==(G=e.replies)?void 0:G.length)?"reply":"replies"]}),s.jsxs("div",{className:"space-y-2",children:[null==(B=e.replies)?void 0:B.slice(0,3).map(e=>{var t;return s.jsxs("div",{className:"text-sm",children:[s.jsxs("span",{className:"font-medium text-gray-900",children:["@",null==(t=e.commenter)?void 0:t.username]}),s.jsx("span",{className:"text-gray-700 ml-2",children:e.comment})]},e.id)}),e.replies&&e.replies.length>3&&s.jsxs("button",{className:"text-xs text-orange-600 hover:text-orange-700 font-medium",children:["View all ",e.replies.length," replies"]})]})]})]})]}),Z&&s.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>ee(!1)})]})};class C extends Error{constructor(e,t,s){super(e),this.statusCode=t,this.errors=s,this.name="CommentApiError"}}const $=new class{constructor(){t(this,"baseUrl","/api/comments")}async handleResponse(e){if(!e.ok){let t,s=`HTTP ${e.status}: ${e.statusText}`;try{const n=await e.json();n.errors?(t=n.errors,s=n.message||s):n.message&&(s=n.message)}catch{}throw new C(s,e.status,t)}try{return await e.json()}catch{throw new C("Failed to parse response JSON")}}async getPostComments(e,t={}){const{page:s=1,perPage:n=20,includeReplies:a=!0,includeLikes:r=!1}=t,i=new URLSearchParams({page:s.toString(),per_page:n.toString(),include_replies:a.toString(),include_likes:r.toString()}),l=await fetch(`${this.baseUrl}/posts/${e}/comments?${i}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(l)}async getComment(e){const t=await fetch(`${this.baseUrl}/${e}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return await this.handleResponse(t)}async getCommentReplies(e,t={}){const{page:s=1,perPage:n=10}=t,a=new URLSearchParams({page:s.toString(),per_page:n.toString()}),r=await fetch(`${this.baseUrl}/${e}/replies?${a}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(r)}async createComment(e){const t=new FormData;t.append("comment",e.comment),e.parentId&&t.append("parent_id",e.parentId.toString());const s=await fetch(`${this.baseUrl}/posts/${e.postId}/comments`,{method:"POST",body:t,credentials:"include"});return this.handleResponse(s)}async createReply(e){if(!e.parentId)throw new C("Parent ID is required for replies");const t=new FormData;t.append("comment",e.comment),t.append("parent_id",e.parentId.toString());const s=await fetch(`${this.baseUrl}/posts/${e.postId}/comments`,{method:"POST",body:t,credentials:"include"});return this.handleResponse(s)}async updateComment(e,t){const s=await fetch(`${this.baseUrl}/${e}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t}),credentials:"include"});return this.handleResponse(s)}async deleteComment(e,t){const s=await fetch(`${this.baseUrl}/posts/${e}/comments/${t}`,{method:"DELETE",credentials:"include"});return this.handleResponse(s)}async toggleCommentLike(e){const t=await fetch(`${this.baseUrl}/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getCommentLikeStatus(e){const t=await fetch(`${this.baseUrl}/${e}/like-status`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getCommentLikes(e){const t=await fetch(`${this.baseUrl}/${e}/likes`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getBatchCommentLikeStatus(e){const t=await fetch(`${this.baseUrl}/batch-like-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({commentIds:e}),credentials:"include"});return this.handleResponse(t)}async getRecentComments(e={}){const{page:t=1,perPage:s=20}=e,n=new URLSearchParams({page:t.toString(),per_page:s.toString()}),a=await fetch(`${this.baseUrl}/recent?${n}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(a)}validateComment(e){const t=e.trim();return t?t.length<1?{isValid:!1,error:"Comment is too short"}:t.length>500?{isValid:!1,error:"Comment is too long (max 500 characters)"}:{isValid:!0}:{isValid:!1,error:"Comment cannot be empty"}}formatCommentForDisplay(e){return{...e,commenter:{...e.commenter,profileImage:e.commenter.profileImage||"/default-avatar.png"},replies:e.replies||[],likes:e.likes||0,isLiked:e.isLiked||!1}}buildCommentTree(e){const t=new Map,s=[];e.forEach(e=>{const s=this.formatCommentForDisplay(e);t.set(e.id,s)}),e.forEach(e=>{const n=t.get(e.id);if(null===e.parentId||void 0===e.parentId)s.push(n);else{const a=t.get(e.parentId);a?(a.replies=a.replies||[],a.replies.push(n)):s.push(n)}}),s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime());const n=e=>{e.replies&&e.replies.length>0&&(e.replies.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()),e.replies.forEach(n))};return s.forEach(n),s}},L=()=>{const[e,t]=n.useState(new Map),s=n.useCallback((e,s,n)=>{t(t=>{const a=new Map(t);return a.set(e,{isLiked:s,likeCount:n,isLoading:!1}),a})},[]),a=n.useCallback(t=>e.get(t)||null,[e]),r=n.useCallback(async e=>{try{const t=await fetch(`/api/posts/${e}/like-status`);if(t.ok){const n=await t.json();s(e,n.isLiked,n.likeCount)}}catch(t){}},[s]),i=n.useCallback(async(e,s,n)=>{t(t=>{const a=new Map(t);return a.set(e,{isLiked:s,likeCount:n,isLoading:!0}),a});const a=!s,r=a?n+1:n-1;t(t=>{const s=new Map(t);return s.set(e,{isLiked:a,likeCount:r,isLoading:!0}),s});try{const s=await fetch(`/api/posts/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error("Failed to toggle like");const n=await s.json();t(t=>{const s=new Map(t);return s.set(e,{isLiked:n.isLiked,likeCount:n.likeCount,isLoading:!1}),s})}catch(i){throw t(t=>{const a=new Map(t);return a.set(e,{isLiked:s,likeCount:n,isLoading:!1}),a}),i}},[]);return{likeStates:e,toggleLike:i,setLikeState:s,getLikeState:a,fetchLikeStatus:r}},S=()=>{const[e,t]=n.useState(!1),[s,a]=n.useState(null);return{isOpen:e,postId:s,openModal:n.useCallback(e=>{a(e),t(!0)},[]),closeModal:n.useCallback(()=>{t(!1),setTimeout(()=>{a(null)},300)},[])}};export{N as C,j as P,S as a,y as b,$ as c,v as s,L as u};
