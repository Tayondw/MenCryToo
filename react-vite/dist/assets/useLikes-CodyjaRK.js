var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{j as s}from"./index-BsJQ2rqb.js";import{r as a}from"./react-vendor-DWDxyCYt.js";import{e as n,X as r,a8 as l,c as i,a9 as o,a6 as c,aa as d,f as m,r as u,a0 as p,a4 as h,J as x,a1 as g,a7 as f,v as b,ab as j,V as y}from"./ui-vendor-DzNpKoho.js";import{L as v}from"./router-vendor-DFbjbkyO.js";import{a as k}from"./redux-vendor-s9F9CGgp.js";const w=({size:e=24,className:t="",color:a="currentColor"})=>s.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:a,className:t,xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",fill:a})}),N=({postId:e,initialLikeCount:t,initialIsLiked:r=!1,onLikeToggle:l,onLikesClick:i,className:o="",showCount:c=!0,size:d=18,disabled:m=!1})=>{const[u,p]=a.useState(r),[h,x]=a.useState(t),[g,f]=a.useState(!1);a.useEffect(()=>{p(r),x(t)},[r,t]);return s.jsxs("div",{className:`flex items-center gap-2 ${o}`,children:[s.jsx("button",{onClick:async()=>{if(m||g)return;const t=!u,s=t?h+1:h-1;p(t),x(s),f(!0);try{const t=await fetch(`/api/posts/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to toggle like");const s=await t.json();p(s.isLiked),x(s.likeCount),l&&l(e,s.isLiked,s.likeCount)}catch(a){p(u),x(h)}finally{f(!1)}},disabled:m||g,className:`flex items-center gap-1 transition-all duration-200 ${u?"text-red-500 hover:text-red-600":"text-slate-500 hover:text-red-500"} ${m||g?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${g?"animate-pulse":""} group`,"aria-label":u?"Unlike post":"Like post",children:u?s.jsx(w,{size:d,className:"transition-transform group-hover:scale-110"}):s.jsx(n,{size:d,className:"transition-transform group-hover:scale-110"})}),c&&s.jsx("button",{onClick:()=>{i&&h>0&&i(e)},className:"text-sm font-medium transition-colors "+(h>0?"text-slate-700 hover:text-orange-600 cursor-pointer":"text-slate-500 cursor-default"),disabled:0===h,"aria-label":`${h} likes`,children:h.toLocaleString()})]})},C=({isOpen:e,onClose:t,postId:o})=>{const[c,d]=a.useState([]),[m,u]=a.useState(!1),[p,h]=a.useState(null),x=a.useCallback(async()=>{u(!0),h(null);try{const e=await fetch(`/api/posts/${o}/likes`);if(!e.ok)throw new Error("Failed to fetch likes");const t=await e.json();d(t.likes||[])}catch(e){h("Failed to load likes. Please try again.")}finally{u(!1)}},[o]);a.useEffect(()=>{e&&o&&x()},[e,o,x]);return a.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",s),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",s),document.body.style.overflow="unset"}},[e,t]),e?s.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:e=>{e.target===e.currentTarget&&t()},children:s.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md max-h-[70vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(n,{size:20,className:"text-red-500"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:"Likes"}),s.jsx("p",{className:"text-sm text-slate-600",children:m?"Loading...":`${c.length} ${1===c.length?"person":"people"} liked this post`})]})]}),s.jsx("button",{onClick:t,className:"p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors",children:s.jsx(r,{size:20})})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:m?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsx(l,{size:24,className:"animate-spin text-orange-500"})}):p?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(n,{size:24,className:"text-red-500"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Oops! Something went wrong"}),s.jsx("p",{className:"text-slate-600 mb-4",children:p}),s.jsx("button",{onClick:x,className:"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors",children:"Try Again"})]}):0===c.length?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(i,{size:24,className:"text-slate-400"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"No likes yet"}),s.jsx("p",{className:"text-slate-600",children:"Be the first to show some love for this post!"})]}):s.jsx("div",{className:"px-6 py-4",children:s.jsx("div",{className:"space-y-3",children:c.map(e=>s.jsxs(v,{to:`/users/${e.id}`,onClick:t,className:"flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group",children:[s.jsx("img",{src:e.profileImage,alt:e.username,className:"w-12 h-12 rounded-full object-cover border-2 border-slate-200 group-hover:border-orange-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-semibold text-slate-900 group-hover:text-orange-600 transition-colors truncate",children:e.username}),s.jsxs("div",{className:"text-sm text-slate-600 truncate",children:[e.firstName," ",e.lastName]})]}),s.jsx("div",{className:"text-red-500 opacity-60 group-hover:opacity-100 transition-opacity",children:s.jsx(n,{size:16,fill:"currentColor"})})]},e.id))})})}),c.length>0&&!m&&s.jsx("div",{className:"p-6 border-t border-slate-200 bg-slate-50",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-sm text-slate-600",children:1===c.length?"1 person likes this post":`${c.length} people like this post`})})})]})}):null};function I(e,t){const s=t.toLowerCase().trim();if(!s)return e;const a=e=>{var t;const n=(e=>{const t=e.comment.toLowerCase().includes(s),a=e.commenter.username.toLowerCase().includes(s),n=e.commenter.firstName.toLowerCase().includes(s),r=e.commenter.lastName.toLowerCase().includes(s);return t||a||n||r})(e),r=(null==(t=e.replies)?void 0:t.map(a).filter(Boolean))||[];return n||r.length>0?{...e,replies:r}:null};return e.map(a).filter(Boolean)}const L=({postId:e,parentId:t=null,replyToUsername:n,onSubmit:l,onCancel:i,placeholder:d="Write a comment...",autoFocus:m=!1,isSubmitting:u=!1})=>{const[p,h]=a.useState(""),[x,g]=a.useState(null),f=a.useRef(null);a.useEffect(()=>{m&&f.current&&f.current.focus()},[m]),a.useEffect(()=>{f.current&&(f.current.style.height="auto",f.current.style.height=`${f.current.scrollHeight}px`)},[p]);const b=async s=>{s.preventDefault(),g(null);const a=function(e){const t=e.trim();return t?t.length<1?{isValid:!1,error:"Comment is too short"}:t.length>500?{isValid:!1,error:"Comment is too long (max 500 characters)"}:{isValid:!0}:{isValid:!1,error:"Comment cannot be empty"}}(p);if(a.isValid)try{await l({comment:p.trim(),postId:e,parentId:t,replyToUsername:n}),h(""),g(null)}catch(r){g(r instanceof Error?r.message:"Failed to post comment")}else g(a.error||"Invalid comment")},j=null!==t&&n,y=j?"Reply":"Comment",v=p.length,k=v>400,w=v>500;return s.jsxs("form",{onSubmit:b,className:"space-y-3",children:[j&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg",children:[s.jsx(o,{size:14}),s.jsxs("span",{children:["Replying to ",s.jsxs("span",{className:"font-medium",children:["@",n]})]}),i&&s.jsx("button",{type:"button",onClick:i,className:"ml-auto text-gray-400 hover:text-gray-600 transition-colors",children:s.jsx(r,{size:14})})]}),s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{ref:f,value:p,onChange:e=>{h(e.target.value),x&&g(null)},onKeyDown:e=>{"Enter"===e.key&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),b(e)),"Escape"===e.key&&i&&(e.preventDefault(),i())},placeholder:d,disabled:u,className:`\n            w-full px-4 py-3 pr-12 border rounded-lg resize-none transition-all duration-200\n            min-h-[80px] max-h-[200px]\n            ${x?"border-red-300 focus:border-red-500 focus:ring-red-200":"border-gray-300 focus:border-orange-500 focus:ring-orange-200"}\n            ${u?"bg-gray-50 cursor-not-allowed":"bg-white"}\n            focus:ring-2 focus:outline-none\n          `,rows:3}),s.jsx("button",{type:"submit",disabled:!p.trim()||u||w,className:`\n            absolute bottom-3 right-3 p-2 rounded-full transition-all duration-200\n            ${!p.trim()||w||u?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 shadow-md hover:shadow-lg"}\n          `,title:`${y} (âŒ˜+Enter)`,children:u?s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):s.jsx(c,{size:16})})]}),s.jsxs("div",{className:"flex items-center justify-between text-sm",children:[s.jsx("div",{className:"flex-1",children:x&&s.jsx("span",{className:"text-red-600 font-medium",children:x})}),s.jsxs("div",{className:`\n          font-medium transition-colors\n          ${w?"text-red-600":k?"text-orange-600":"text-gray-400"}\n        `,children:[v,"/",500]})]}),j&&s.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[i&&s.jsx("button",{type:"button",onClick:i,disabled:u,className:"px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:!p.trim()||u||w,className:`\n              px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200\n              ${!p.trim()||w||u?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-orange-500 text-white hover:bg-orange-600 shadow-md hover:shadow-lg"}\n            `,children:u?"Posting...":y})]}),s.jsxs("div",{className:"text-xs text-gray-400 text-right",children:[s.jsx("span",{children:"âŒ˜+Enter to post"}),i&&s.jsx("span",{children:" â€¢ Esc to cancel"})]})]})},S=({commentId:e,initialLikeCount:t,initialIsLiked:r=!1,onLikeToggle:l,onLikesClick:i,className:o="",showCount:c=!0,size:d=14,disabled:m=!1})=>{const[u,p]=a.useState(r),[h,x]=a.useState(t),[g,f]=a.useState(!1);a.useEffect(()=>{p(r),x(t)},[r,t,e]),a.useEffect(()=>{0!==t||r||(async()=>{try{const t=await fetch(`/api/comments/${e}/like-status`,{credentials:"include"});if(t.ok){const e=await t.json();p(e.isLiked),x(e.likeCount)}}catch(t){}})()},[e,t,r]);const b=a.useCallback(async()=>{if(m||g)return;const t=!u,s=t?h+1:Math.max(0,h-1);p(t),x(s),f(!0);try{const t=await fetch(`/api/comments/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const s=await t.json();s.success?(p(s.isLiked),x(s.likeCount),l&&l(e,s.isLiked,s.likeCount)):(p(u),x(h))}catch(a){p(u),x(h)}finally{f(!1)}},[e,m,g,u,h,l]),j=a.useCallback(t=>{t.stopPropagation(),i&&h>0&&i(e)},[i,e,h]),y=a.useCallback(e=>{e.stopPropagation(),b()},[b]);return s.jsxs("div",{className:`flex items-center gap-1 ${o}`,children:[s.jsx("button",{onClick:y,disabled:m||g,className:`flex items-center transition-all duration-200 ${u?"text-red-500 hover:text-red-600":"text-slate-400 hover:text-red-500"} ${m||g?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${g?"animate-pulse":""} group`,"aria-label":u?"Unlike comment":"Like comment",title:u?"Unlike comment":"Like comment",children:u?s.jsx(w,{size:d,className:"transition-transform group-hover:scale-110",color:"currentColor"}):s.jsx(n,{size:d,className:"transition-transform group-hover:scale-110",fill:"none"})}),(c||h>0)&&h>0&&s.jsx("button",{onClick:j,className:"text-xs font-medium transition-colors text-slate-600 hover:text-red-500 cursor-pointer",disabled:0===h,"aria-label":`${h} likes`,title:`${h} ${1===h?"like":"likes"}`,children:h.toLocaleString()}),g&&s.jsx("div",{className:"w-3 h-3 border border-red-300 border-t-red-500 rounded-full animate-spin ml-1"})]})},$=({comment:e,depth:t=0,maxDepth:n=5,sessionUser:r,postUser:l,allComments:i=[],replyToComment:c,setReplyToComment:f,replyText:b="",setReplyText:j,isSubmitting:y=!1,showAllReplies:k={},toggleShowAllReplies:w,onReply:N,onEdit:C,onDelete:I,handleAddReply:T,onLikeToggle:E,onShowLikes:z,formatTimeAgo:R,currentUserId:A})=>{var U,D,M,O,P,F,_,V,B,G;const[H,J]=a.useState(!1),[K,W]=a.useState(!1),[Y,q]=a.useState(e.comment),[Q,X]=a.useState(!0),[Z,ee]=a.useState(!1),[te,se]=a.useState(!1),[ae,ne]=a.useState(e.likes||0),[re,le]=a.useState(e.isLiked||!1),ie=!!(r&&f&&T),oe=A||(null==r?void 0:r.id),ce=function(e,t){return void 0!==t&&e.userId===t}(e,oe),de=e.replies&&e.replies.length>0,me=t<n,ue=function(e){const t=e.match(/^@(\w+)/);return t?t[1]:null}(e.comment),pe=ie?0:2,he=e.replies&&e.replies.length>pe,xe=(null==k?void 0:k[e.id])??te,ge=xe?e.replies:null==(U=e.replies)?void 0:U.slice(0,pe);a.useEffect(()=>{},[e.id,e.likes,e.isLiked,ae,re]);const fe=a.useCallback(e=>{if(0===e)return"";switch(e){case 1:return"ml-12";case 2:return"ml-16";case 3:return"ml-20";default:return"ml-24"}},[]),be=a.useMemo(()=>e.commenter?{id:e.commenter.id,username:e.commenter.username||"Unknown User",firstName:e.commenter.firstName||"",lastName:e.commenter.lastName||"",profileImage:e.commenter.profileImage||"/default-avatar.png"}:{id:e.userId,username:"Unknown User",firstName:"",lastName:"",profileImage:"/default-avatar.png"},[e.commenter,e.userId]),je=a.useCallback(e=>{if(!ie||!l||!i.length){const t=/@([\w-]+)/g;return e.split(t).map((e,t)=>t%2==1?s.jsxs("span",{className:"text-orange-600 font-medium",children:["@",e]},t):e)}const t=/@([\w-]+)/g,a=[];let n,o=0;for(;null!==(n=t.exec(e));){n.index>o&&a.push(e.slice(o,n.index));const t=n[1];let c=null;if(r&&t===r.username)c=r.id;else if(t===l.username)c=l.id;else{const e=s=>{var a;for(const n of s){if((null==(a=n.commenter)?void 0:a.username)===t)return n.commenter.id;if(n.replies){const t=e(n.replies);if(t)return t}}return null};c=e(i)}a.push(s.jsxs(v,{to:`/users/${c||t}`,className:"text-orange-600 hover:text-orange-700 font-medium",children:["@",t]},`mention-${n.index}`)),o=n.index+n[0].length}return o<e.length&&a.push(e.slice(o)),0===a.length?e:a},[ie,l,i,r]);a.useEffect(()=>{void 0!==e.likes&&ne(e.likes),void 0!==e.isLiked&&le(e.isLiked)},[e.likes,e.isLiked,e.id,re,ae]);const ye=a.useCallback(async(t,s,a)=>{t===e.id&&void 0!==s&&void 0!==a&&(le(s),ne(a),E&&E(t,s,a))},[e.id,E]),ve=a.useCallback(e=>{z&&z(e)},[z]),ke=()=>{w?w(e.id):se(!te)},we=()=>R?R(e.createdAt):function(e){const t=new Date,s=new Date(e),a=Math.floor((t.getTime()-s.getTime())/1e3);if(a<10)return"just now";if(a<60)return`${a}s ago`;const n=Math.floor(a/60);if(n<60)return`${n}m ago`;const r=Math.floor(n/60);if(r<24)return`${r}h ago`;const l=Math.floor(r/24);if(l<7)return`${l}d ago`;const i=Math.floor(l/7);return i<4?`${i}w ago`:s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:s.getFullYear()!==t.getFullYear()?"numeric":void 0})}(e.createdAt);return s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:`flex gap-3 ${t>0?fe(t):""} ${ie?"":"group"}`,children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx(v,{to:`/users/${be.id}`,children:s.jsx("img",{src:be.profileImage,alt:be.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{const t=e.target;"/default-avatar.png"!==t.src&&(t.src="/default-avatar.png")}})})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[ie?s.jsxs("div",{className:"bg-slate-50 rounded-lg p-3",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx(v,{to:`/users/${be.id}`,className:"font-semibold text-slate-900 text-sm hover:text-orange-600 transition-colors",children:be.firstName&&be.lastName?`${be.firstName} ${be.lastName}`:be.username}),s.jsx("span",{className:"text-xs text-slate-500",children:we()})]}),s.jsx("div",{className:"text-slate-700 text-sm mb-2",children:je(e.comment)}),s.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[r&&s.jsx(S,{commentId:e.id,initialLikeCount:ae,initialIsLiked:re,onLikeToggle:ye,onLikesClick:ve,size:12,showCount:!0}),r&&s.jsxs("button",{onClick:()=>{f&&j&&(f(e.id),b.includes(`@${be.username}`)||j(`@${be.username} `))},className:"flex items-center gap-1 hover:text-orange-600 transition-colors",children:[s.jsx(d,{size:12}),"Reply"]}),de&&s.jsxs("button",{onClick:()=>X(!Q),className:"flex items-center gap-1 hover:text-blue-500 transition-colors",children:[Q?s.jsx(m,{size:12}):s.jsx(u,{size:12}),null==(D=e.replies)?void 0:D.length," ",1===(null==(M=e.replies)?void 0:M.length)?"reply":"replies"]})]})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("span",{className:"font-semibold text-gray-900 text-sm",children:[be.firstName," ",be.lastName]}),s.jsxs("span",{className:"text-gray-500 text-sm",children:["@",be.username]}),s.jsx("span",{className:"text-gray-400 text-xs",children:we()}),ce&&s.jsxs("div",{className:"relative ml-auto opacity-0 group-hover:opacity-100 transition-opacity",children:[s.jsx("button",{onClick:()=>ee(!Z),className:"p-1 hover:bg-gray-100 rounded-full transition-colors",children:s.jsx(p,{size:14})}),Z&&s.jsxs("div",{className:"absolute right-0 top-6 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-10 min-w-[120px]",children:[s.jsxs("button",{onClick:()=>{W(!0),ee(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",children:[s.jsx(h,{size:14}),"Edit"]}),s.jsxs("button",{onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{await(null==I?void 0:I(e.id))}catch(t){}ee(!1)},className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50",children:[s.jsx(x,{size:14}),"Delete"]})]})]})]}),s.jsx("div",{className:"mb-2",children:K?s.jsxs("div",{className:"space-y-2",children:[s.jsx("textarea",{value:Y,onChange:e=>q(e.target.value),className:"w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none",rows:2,autoFocus:!0}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:async()=>{if(Y.trim()!==e.comment)try{await(null==C?void 0:C(e.id,Y.trim())),W(!1)}catch(t){q(e.comment)}else W(!1)},disabled:!Y.trim(),className:"px-3 py-1 bg-orange-500 text-white text-sm rounded-lg hover:bg-orange-600 disabled:bg-gray-300",children:"Save"}),s.jsx("button",{onClick:()=>{W(!1),q(e.comment)},className:"px-3 py-1 text-gray-600 text-sm hover:text-gray-800",children:"Cancel"})]})]}):s.jsxs("div",{className:"text-gray-800 text-sm leading-relaxed",children:[ue&&s.jsxs("span",{className:"inline-flex items-center gap-1 text-orange-600 font-medium mr-1",children:[s.jsx(o,{size:12}),ue]}),s.jsx("span",{children:ue?e.comment.replace(`@${ue}`,"").trim():e.comment})]})})]}),!K&&!ie&&s.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500",children:[r&&s.jsx(S,{commentId:e.id,initialLikeCount:ae,initialIsLiked:re,onLikeToggle:ye,onLikesClick:ve,size:12,showCount:!0}),r&&s.jsxs("button",{onClick:()=>J(!0),className:"flex items-center gap-1 hover:text-orange-600 transition-colors",children:[s.jsx(d,{size:12}),"Reply"]}),de&&s.jsxs("button",{onClick:()=>X(!Q),className:"flex items-center gap-1 hover:text-blue-500 transition-colors",children:[Q?s.jsx(m,{size:12}):s.jsx(u,{size:12}),null==(O=e.replies)?void 0:O.length," ",1===(null==(P=e.replies)?void 0:P.length)?"reply":"replies"]})]}),H&&!ie&&s.jsx("div",{className:"mt-3",children:s.jsx(L,{postId:e.postId,parentId:e.id,replyToUsername:null==(F=e.commenter)?void 0:F.username,onSubmit:async()=>{var t;try{await(null==N?void 0:N(e.id,(null==(t=e.commenter)?void 0:t.username)||"")),J(!1)}catch(s){throw s}},onCancel:()=>J(!1),placeholder:`Reply to @${null==(_=e.commenter)?void 0:_.username}...`,autoFocus:!0})}),c===e.id&&ie&&r&&j&&s.jsxs("div",{className:`flex gap-3 mt-3 ${fe(1)}`,children:[s.jsx(v,{to:`/users/${r.id}`,className:"flex-shrink-0",children:s.jsx("img",{src:r.profileImage||"/default-avatar.png",alt:r.username,className:"w-8 h-8 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{const t=e.target;"/default-avatar.png"!==t.src&&(t.src="/default-avatar.png")}})}),s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{value:b,onChange:e=>j(e.target.value),placeholder:`Reply to @${be.username}...`,className:"w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none text-sm",rows:2,onFocus:()=>{b.includes(`@${be.username}`)||j(`@${be.username} `)}}),s.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.jsx("button",{onClick:()=>{f(null),j("")},className:"text-xs text-slate-500 hover:text-slate-700",children:"Cancel"}),s.jsx("button",{onClick:()=>{let t=b.trim();t.includes(`@${be.username}`)||(t=`@${be.username} ${t}`),j(t),null==T||T(e.id)},disabled:!b.trim()||y,className:"px-3 py-1 bg-orange-500 text-white text-xs rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:y?"Posting...":"Reply"})]})]})})]}),de&&(Q||ie)&&me&&s.jsxs("div",{className:"mt-3 space-y-3",children:[null==ge?void 0:ge.map(e=>s.jsx($,{comment:e,depth:t+1,maxDepth:n,sessionUser:r,postUser:l,allComments:i,replyToComment:c,setReplyToComment:f,replyText:b,setReplyText:j,isSubmitting:y,showAllReplies:k,toggleShowAllReplies:w,onReply:N,onEdit:C,onDelete:I,handleAddReply:T,onLikeToggle:E,onShowLikes:z,formatTimeAgo:R,currentUserId:A},e.id)),he&&s.jsx("div",{className:ie?fe(t+1):"mt-2",children:xe?s.jsx("button",{onClick:ke,className:"text-sm text-slate-600 hover:text-slate-700 font-medium",children:"Show less"}):s.jsxs("button",{onClick:ke,className:"text-sm text-orange-600 hover:text-orange-700 font-medium",children:["View ",e.replies.length-pe," more replies"]})})]}),de&&(Q||ie)&&!me&&!ie&&s.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:[s.jsxs("div",{className:"text-xs text-gray-600 mb-2 flex items-center gap-1",children:[s.jsx(g,{size:12}),null==(V=e.replies)?void 0:V.length," more"," ",1===(null==(B=e.replies)?void 0:B.length)?"reply":"replies"]}),s.jsxs("div",{className:"space-y-2",children:[null==(G=e.replies)?void 0:G.slice(0,3).map(e=>{var t;return s.jsxs("div",{className:"text-sm",children:[s.jsxs("span",{className:"font-medium text-gray-900",children:["@",null==(t=e.commenter)?void 0:t.username]}),s.jsx("span",{className:"text-gray-700 ml-2",children:e.comment})]},e.id)}),e.replies&&e.replies.length>3&&s.jsxs("button",{className:"text-xs text-orange-600 hover:text-orange-700 font-medium",children:["View all ",e.replies.length," replies"]})]})]})]})]}),Z&&s.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>ee(!1)})]})},T=({isOpen:e,onClose:t,commentId:o})=>{const[c,d]=a.useState([]),[m,u]=a.useState(!1),[p,h]=a.useState(null),[x,f]=a.useState(""),b=a.useCallback(async()=>{u(!0),h(null);try{const e=await fetch(`/api/comments/${o}/likes`,{credentials:"include"});if(!e.ok)throw new Error("Failed to fetch comment likes");const t=await e.json();d(t.likes||[]),f(t.comment||"")}catch(e){h("Failed to load likes. Please try again.")}finally{u(!1)}},[o]),j=a.useCallback(async()=>{try{const e=await fetch(`/api/comments/${o}`,{credentials:"include"});if(e.ok){const t=await e.json();f(t.comment||"")}}catch(e){}},[o]);a.useEffect(()=>{e&&o&&(b(),j())},[e,o,b,j]);return a.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",s),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",s),document.body.style.overflow="unset"}},[e,t]),e?s.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:e=>{e.target===e.currentTarget&&t()},children:s.jsxs("div",{className:"bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md max-h-[70vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(n,{size:20,className:"text-red-500"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold text-slate-900",children:"Comment Likes"}),s.jsx("p",{className:"text-sm text-slate-600",children:m?"Loading...":`${c.length} ${1===c.length?"person":"people"} liked this comment`})]})]}),s.jsx("button",{onClick:t,className:"p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors",children:s.jsx(r,{size:20})})]}),x&&s.jsx("div",{className:"p-4 border-b border-slate-100 bg-slate-50",children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(g,{size:16,className:"text-slate-400 mt-0.5 flex-shrink-0"}),s.jsx("p",{className:"text-sm text-slate-700 line-clamp-2",children:x.length>100?`${x.slice(0,100)}...`:x})]})}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:m?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsx(l,{size:24,className:"animate-spin text-red-500"})}):p?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(n,{size:24,className:"text-red-500"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"Oops! Something went wrong"}),s.jsx("p",{className:"text-slate-600 mb-4",children:p}),s.jsx("button",{onClick:b,className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Try Again"})]}):0===c.length?s.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4",children:s.jsx(i,{size:24,className:"text-slate-400"})}),s.jsx("h3",{className:"text-lg font-semibold text-slate-900 mb-2",children:"No likes yet"}),s.jsx("p",{className:"text-slate-600",children:"Be the first to show some love for this comment!"})]}):s.jsx("div",{className:"px-6 py-4",children:s.jsx("div",{className:"space-y-3",children:c.map(e=>s.jsxs(v,{to:`/users/${e.id}`,onClick:t,className:"flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 transition-colors group",children:[s.jsx("img",{src:e.profileImage,alt:e.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 group-hover:border-red-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-medium text-slate-900 group-hover:text-red-600 transition-colors truncate",children:e.username}),s.jsxs("div",{className:"text-sm text-slate-600 truncate",children:[e.firstName," ",e.lastName]})]}),s.jsx("div",{className:"text-red-500 opacity-60 group-hover:opacity-100 transition-opacity",children:s.jsx(n,{size:14,fill:"currentColor"})})]},e.id))})})}),c.length>0&&!m&&s.jsx("div",{className:"p-4 border-t border-slate-200 bg-slate-50",children:s.jsx("div",{className:"text-center",children:s.jsx("p",{className:"text-sm text-slate-600",children:1===c.length?"1 person likes this comment":`${c.length} people like this comment`})})})]})}):null};class E extends Error{constructor(e,t,s){super(e),this.statusCode=t,this.errors=s,this.name="CommentApiError"}}const z=new class{constructor(){t(this,"baseUrl","/api/comments")}async handleResponse(e){if(!e.ok){let t,s=`HTTP ${e.status}: ${e.statusText}`;try{const a=await e.json();a.errors?(t=a.errors,s=a.message||s):a.message&&(s=a.message)}catch{}throw new E(s,e.status,t)}try{return await e.json()}catch(t){throw new E("Failed to parse response JSON")}}async getPostComments(e,t={}){const{page:s=1,perPage:a=20,includeReplies:n=!0,includeLikes:r=!1}=t,l=new URLSearchParams({page:s.toString(),per_page:a.toString(),include_replies:n.toString(),include_likes:r.toString()}),i=await fetch(`${this.baseUrl}/posts/${e}/comments?${l}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(i)}async getComment(e){const t=await fetch(`${this.baseUrl}/${e}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return await this.handleResponse(t)}async getCommentReplies(e,t={}){const{page:s=1,perPage:a=10}=t,n=new URLSearchParams({page:s.toString(),per_page:a.toString()}),r=await fetch(`${this.baseUrl}/${e}/replies?${n}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(r)}async createComment(e){const t=new FormData;t.append("comment",e.comment),e.parentId&&t.append("parent_id",e.parentId.toString());const s=await fetch(`${this.baseUrl}/posts/${e.postId}/comments`,{method:"POST",body:t,credentials:"include"});return this.handleResponse(s)}async createReply(e){if(!e.parentId)throw new E("Parent ID is required for replies");const t=new FormData;t.append("comment",e.comment),t.append("parent_id",e.parentId.toString());const s=await fetch(`${this.baseUrl}/posts/${e.postId}/comments`,{method:"POST",body:t,credentials:"include"});return this.handleResponse(s)}async updateComment(e,t){const s=await fetch(`${this.baseUrl}/${e}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t}),credentials:"include"});return this.handleResponse(s)}async deleteComment(e,t){const s=await fetch(`${this.baseUrl}/posts/${e}/comments/${t}`,{method:"DELETE",credentials:"include"});return this.handleResponse(s)}async toggleCommentLike(e){const t=await fetch(`${this.baseUrl}/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getCommentLikeStatus(e){const t=await fetch(`${this.baseUrl}/${e}/like-status`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getCommentLikes(e){const t=await fetch(`${this.baseUrl}/${e}/likes`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(t)}async getBatchCommentLikeStatus(e){const t=await fetch(`${this.baseUrl}/batch-like-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({commentIds:e}),credentials:"include"});return this.handleResponse(t)}async getRecentComments(e={}){const{page:t=1,perPage:s=20}=e,a=new URLSearchParams({page:t.toString(),per_page:s.toString()}),n=await fetch(`${this.baseUrl}/recent?${a}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});return this.handleResponse(n)}validateComment(e){const t=e.trim();return t?t.length<1?{isValid:!1,error:"Comment is too short"}:t.length>500?{isValid:!1,error:"Comment is too long (max 500 characters)"}:{isValid:!0}:{isValid:!1,error:"Comment cannot be empty"}}formatCommentForDisplay(e){return{...e,commenter:{...e.commenter,profileImage:e.commenter.profileImage||"/default-avatar.png"},replies:e.replies||[],likes:e.likes||0,isLiked:e.isLiked||!1}}buildCommentTree(e){const t=new Map,s=[];e.forEach(e=>{const s=this.formatCommentForDisplay(e);t.set(e.id,s)}),e.forEach(e=>{const a=t.get(e.id);if(null===e.parentId||void 0===e.parentId)s.push(a);else{const n=t.get(e.parentId);n?(n.replies=n.replies||[],n.replies.push(a)):s.push(a)}}),s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime());const a=e=>{e.replies&&e.replies.length>0&&(e.replies.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()),e.replies.forEach(a))};return s.forEach(a),s}},R=({isOpen:e,onClose:t,postId:n,initialComments:o=[]})=>{const d=k(e=>e.session.user),m=a.useRef(null),[u,p]=a.useState([]),[h,x]=a.useState(!1),[w,N]=a.useState(!1),[C,L]=a.useState(null),[S,E]=a.useState(""),[R,A]=a.useState("newest"),[U,D]=a.useState(!1),[M,O]=a.useState(""),[P,F]=a.useState(null),[_,V]=a.useState(""),[B,G]=a.useState({}),[H,J]=a.useState({isOpen:!1,commentId:null}),[K,W]=a.useState(new Map);a.useEffect(()=>{if(u&&u.length>0){const e=new Map;(t=>{t.forEach(t=>{e.set(t.id,{isLiked:t.isLiked||!1,likeCount:t.likes||0})})})(u),W(e)}},[u]);const Y=a.useCallback(e=>{const t=[],s=e=>{var a;const n={id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,username:(null==(a=e.commenter)?void 0:a.username)||"Unknown User",parentId:e.parentId,created_at:e.createdAt,updated_at:e.updatedAt,commenter:e.commenter,likes:e.likes||0,isLiked:e.isLiked||!1};t.push(n),e.replies&&e.replies.length>0&&e.replies.forEach(s)};return e.forEach(s),t},[]),q=a.useCallback(e=>{if(!e||0===e.length)return[];const t=new Map,s=[];return e.forEach(e=>{let s;s=e.commenter?{id:e.commenter.id,username:e.commenter.username,firstName:e.commenter.firstName||"",lastName:e.commenter.lastName||"",profileImage:e.commenter.profileImage||"/default-avatar.png"}:d&&e.userId===d.id?{id:d.id,username:d.username,firstName:d.firstName||"",lastName:d.lastName||"",profileImage:d.profileImage||"/default-avatar.png"}:{id:e.userId,username:e.username||"Unknown User",firstName:"",lastName:"",profileImage:"/default-avatar.png"};const a=K.get(e.id),n=(null==a?void 0:a.likeCount)??e.likes??0,r=(null==a?void 0:a.isLiked)??e.isLiked??!1,l={id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,parentId:e.parentId,createdAt:e.created_at,updatedAt:e.updated_at,commenter:s,replies:[],likes:n,isLiked:r};t.set(e.id,l)}),e.forEach(e=>{const a=t.get(e.id);if(null===e.parentId||void 0===e.parentId)s.push(a);else{const n=t.get(e.parentId);n?(n.replies=n.replies||[],n.replies.push(a)):s.push(a)}}),s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),s.forEach(e=>{e.replies&&e.replies.length>0&&e.replies.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime())}),s},[d,K]),Q=a.useMemo(()=>{if(u&&u.length>0){return q(u)}return[]},[u,q,K.size]),X=a.useMemo(()=>{let e=[...Q];return S.trim()&&(e=I(e,S)),e.sort((e,t)=>{var s,a;switch(R){case"oldest":return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime();case"popular":{const n=e.likes||0,r=t.likes||0;if(n!==r)return r-n;const l=(null==(s=e.replies)?void 0:s.length)||0,i=(null==(a=t.replies)?void 0:a.length)||0;return l!==i?i-l:new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()}default:return new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()}}),e},[Q,S,R]),Z=a.useCallback(async()=>{if(n){x(!0),L(null);try{const e=await fetch(`/api/posts/${n}`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=(await e.json()).postComments||[];p(t),D(!0)}catch(e){L(e instanceof Error?e.message:"Failed to load comments")}finally{x(!1)}}},[n]);a.useEffect(()=>{if(!e||!n)return p([]),L(null),O(""),F(null),V(""),G({}),E(""),D(!1),void J({isOpen:!1,commentId:null});if(L(null),O(""),F(null),V(""),G({}),o&&o.length>0){if(o.some(e=>e.replies&&e.replies.length>0)){const e=Y(o);p(e),D(!0)}else{const e=o.map(e=>{var t;return{id:e.id,userId:e.userId,postId:e.postId,comment:e.comment,username:(null==(t=e.commenter)?void 0:t.username)||"Unknown User",parentId:e.parentId,created_at:e.createdAt,updated_at:e.updatedAt,commenter:e.commenter,likes:e.likes||0,isLiked:e.isLiked||!1}});p(e),D(!0)}Z()}else Z()},[e,n,o,Z,Y]),a.useEffect(()=>{if(u&&u.length>0){const e=new Map;(t=>{t.forEach(t=>{const s=t.likes??0,a=t.isLiked??!1;e.set(t.id,{isLiked:a,likeCount:s})})})(u),W(e)}},[u]);const ee=a.useCallback(e=>{const t=new Date,s=new Date(e),a=Math.floor((t.getTime()-s.getTime())/36e5);if(a<1)return"just now";if(a<24)return`${a}h ago`;const n=Math.floor(a/24);return n<7?`${n}d ago`:s.toLocaleDateString()},[]),te=a.useCallback(async()=>{if(d&&M.trim()){N(!0);try{const e=await z.createComment({comment:M.trim(),postId:n}),t={id:e.comment.id,userId:d.id,postId:n,comment:M.trim(),username:d.username,parentId:null,created_at:e.comment.createdAt,updated_at:e.comment.updatedAt,commenter:{id:d.id,username:d.username,firstName:d.firstName||"",lastName:d.lastName||"",profileImage:d.profileImage||"/default-avatar.png"},likes:0,isLiked:!1};W(e=>{const s=new Map(e);return s.set(t.id,{isLiked:!1,likeCount:0}),s}),p(e=>[t,...e]),O("")}catch(e){L("Failed to add comment")}finally{N(!1)}}},[d,M,n]),se=a.useCallback(e=>{for(const t of Q){if(t.id===e)return t;if(t.replies)for(const s of t.replies)if(s.id===e)return s}return null},[Q]),ae=a.useCallback(async e=>{var t;if(d&&_.trim()){N(!0);try{const s=se(e),a=(null==(t=null==s?void 0:s.commenter)?void 0:t.username)||"",r=await z.createReply({comment:_.trim(),postId:n,parentId:e,replyToUsername:a}),l={id:r.comment.id,userId:d.id,postId:n,comment:_.trim(),username:d.username,parentId:e,created_at:r.comment.createdAt,updated_at:r.comment.updatedAt,commenter:{id:d.id,username:d.username,firstName:d.firstName||"",lastName:d.lastName||"",profileImage:d.profileImage||"/default-avatar.png"},likes:0,isLiked:!1};W(e=>{const t=new Map(e);return t.set(l.id,{isLiked:!1,likeCount:0}),t}),p(e=>[...e,l]),V(""),F(null)}catch(s){L("Failed to add reply")}finally{N(!1)}}},[d,_,n,se]),ne=async(e,t)=>{try{await z.updateComment(e,t),p(s=>s.map(s=>s.id===e?{...s,comment:t}:s))}catch(s){throw s}},re=async e=>{try{await z.deleteComment(n,e),p(t=>t.filter(t=>t.id!==e&&t.parentId!==e))}catch(t){throw t}},le=a.useCallback(async(e,t,s)=>{void 0!==t&&void 0!==s&&(W(a=>{const n=new Map(a);return n.set(e,{isLiked:t,likeCount:s}),n}),p(a=>a.map(a=>a.id===e?{...a,likes:s,isLiked:t}:a)))},[]);a.useEffect(()=>{},[K]);const ie=a.useCallback(e=>{J({isOpen:!0,commentId:e})},[]),oe=a.useCallback(()=>{J({isOpen:!1,commentId:null})},[]),ce=a.useCallback(e=>{G(t=>({...t,[e]:!t[e]}))},[]),de=a.useCallback(()=>{D(!1),Z()},[Z]),me=a.useCallback(()=>{E(""),L(null),p([]),O(""),F(null),V(""),G({}),D(!1),J({isOpen:!1,commentId:null}),t()},[t]),ue=a.useCallback(e=>{m.current&&!m.current.contains(e.target)&&me()},[me]);if(a.useEffect(()=>{const t=e=>{"Escape"===e.key&&me()};return e&&(document.addEventListener("keydown",t),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",t),document.body.style.overflow="unset"}},[e,me]),a.useEffect(()=>{e&&n&&U&&W(new Map)},[e,n,U]),!e)return null;const pe=u.length,he=X.length,xe=h&&!U;return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:ue,children:s.jsxs("div",{ref:m,className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col",children:[s.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-orange-500 to-slate-600 rounded-full flex items-center justify-center",children:s.jsx(g,{className:"text-white",size:20})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Comments"}),s.jsxs("p",{className:"text-sm text-gray-600",children:[pe," ",1===pe?"comment":"comments",S&&he!==pe&&s.jsxs("span",{children:[" â€¢ ",he," shown"]})]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:de,disabled:h,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:"Refresh comments",children:s.jsx(f,{size:18,className:h?"animate-spin":""})}),s.jsx("button",{onClick:me,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:s.jsx(r,{size:18})})]})]}),s.jsxs("div",{className:"p-4 border-b border-gray-100 space-y-3",children:[s.jsxs("div",{className:"relative",children:[s.jsx(b,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),s.jsx("input",{type:"text",placeholder:"Search comments...",value:S,onChange:e=>E(e.target.value),className:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(j,{size:16,className:"text-gray-500"}),s.jsxs("select",{value:R,onChange:e=>A(e.target.value),className:"border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500",children:[s.jsx("option",{value:"newest",children:"Newest first"}),s.jsx("option",{value:"oldest",children:"Oldest first"}),s.jsx("option",{value:"popular",children:"Most popular"})]})]})]}),d&&s.jsx("div",{className:"p-4 border-b border-gray-100",children:s.jsxs("div",{className:"flex gap-3",children:[s.jsx(v,{to:`/users/${d.id}`,className:"flex-shrink-0",children:s.jsx("img",{src:d.profileImage||"/default-avatar.png",alt:d.username,className:"w-10 h-10 rounded-full object-cover border-2 border-slate-200 hover:border-orange-500 transition-colors",onError:e=>{e.target.src="/default-avatar.png"}})}),s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{value:M,onChange:e=>O(e.target.value),placeholder:"Write a comment...",className:"w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none",rows:3,disabled:w}),s.jsx("button",{onClick:te,disabled:!M.trim()||w,className:"absolute bottom-3 right-3 p-2 bg-orange-500 text-white rounded-full hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:w?s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):s.jsx(c,{size:16})})]})})]})}),s.jsxs("div",{className:"flex-1 overflow-y-auto",children:[C&&s.jsxs("div",{className:"p-4 m-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700",children:[s.jsx(y,{size:16}),s.jsx("span",{children:C}),s.jsx("button",{onClick:de,className:"ml-auto text-red-600 hover:text-red-800 font-medium",children:"Retry"})]}),xe?s.jsx("div",{className:"p-8 text-center",children:s.jsxs("div",{className:"inline-flex items-center gap-2 text-gray-600",children:[s.jsx(l,{className:"animate-spin",size:20}),"Loading comments..."]})}):0===X.length?s.jsxs("div",{className:"p-8 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:s.jsx(g,{className:"text-gray-400",size:24})}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:S?"No comments found":"No comments yet"}),s.jsx("p",{className:"text-gray-600 mb-4",children:S?"Try adjusting your search terms":"Be the first to share your thoughts!"}),S&&s.jsx("button",{onClick:()=>E(""),className:"text-orange-600 hover:text-orange-700 font-medium",children:"Clear search"})]}):s.jsx("div",{className:"p-4 space-y-6",children:X.map(e=>s.jsx($,{comment:e,depth:0,maxDepth:5,sessionUser:d,postUser:void 0,allComments:X,replyToComment:P,setReplyToComment:F,replyText:_,setReplyText:V,handleAddReply:ae,isSubmitting:w,formatTimeAgo:ee,showAllReplies:B,toggleShowAllReplies:ce,onEdit:ne,onDelete:re,onLikeToggle:le,onShowLikes:ie},e.id))})]}),s.jsx("div",{className:"p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl",children:s.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[s.jsx("div",{className:"flex items-center gap-4",children:s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(i,{size:14}),pe," ",1===pe?"participant":"participants"]})}),!d&&s.jsx("div",{className:"text-right",children:s.jsxs("span",{children:[s.jsx("a",{href:"/login",className:"text-orange-600 hover:text-orange-700 font-medium",children:"Sign in"})," ","to join the conversation"]})})]})})]})}),H.isOpen&&H.commentId&&s.jsx(T,{isOpen:H.isOpen,onClose:oe,commentId:H.commentId,initialCount:0})]})},A=(e={})=>{const{initialComments:t=[],autoLoad:s=!1}=e,[n,r]=a.useState({isOpen:!1,postId:null,comments:t,isLoading:!1,error:null,page:1,hasMore:!0}),[l,i]=a.useState(t),[o,c]=a.useState(!1),[d,m]=a.useState(null),u=a.useRef(!1),p=a.useRef(null),h=a.useCallback(()=>{m(null),r(e=>({...e,error:null}))},[]),x=a.useCallback(async(e,t=1)=>{if(u.current)return[];u.current=!0,c(!0),h();try{const s=await z.getPostComments(e,t,20),a=s.comments||[];return 1===t?(i(a),r(e=>{var t;return{...e,comments:a,page:2,hasMore:(null==(t=s.pagination)?void 0:t.hasNext)||!1}})):(i(e=>[...e,...a]),r(e=>{var n;return{...e,comments:[...e.comments,...a],page:t+1,hasMore:(null==(n=s.pagination)?void 0:n.hasNext)||!1}})),p.current=e,a}catch(s){const e=s instanceof Error?s.message:"Failed to load comments";throw m(e),r(t=>({...t,error:e})),s}finally{c(!1),u.current=!1,r(e=>({...e,isLoading:!1}))}},[h]),g=a.useCallback(async()=>{p.current&&await x(p.current,1)},[x]),f=a.useCallback((e,t)=>{r(s=>({...s,isOpen:!0,postId:e,comments:t||[],page:1,hasMore:!0,error:null})),t&&i(t),t&&0!==t.length||x(e,1)},[x]),b=a.useCallback(()=>{r(e=>({...e,isOpen:!1,postId:null,error:null}))},[]),j=a.useCallback(async e=>{try{const t=(e.parentId?await z.createReply(e):await z.createComment(e)).comment;return i(e=>[t,...e]),r(e=>({...e,comments:[t,...e.comments]})),t}catch(t){const e=t instanceof Error?t.message:"Failed to add comment";throw m(e),t}},[]),y=a.useCallback(async(e,t)=>{try{await z.updateComment(e,t);const s=a=>a.map(a=>a.id===e?{...a,comment:t,updatedAt:(new Date).toISOString()}:a.replies?{...a,replies:s(a.replies)}:a);i(e=>s(e)),r(e=>({...e,comments:s(e.comments)}))}catch(s){const e=s instanceof Error?s.message:"Failed to edit comment";throw m(e),s}},[]),v=a.useCallback(async e=>{if(!n.postId)throw new Error("No post ID available");try{await z.deleteComment(n.postId,e);const t=s=>s.filter(s=>s.id!==e&&(s.replies&&(s.replies=t(s.replies)),!0));i(e=>t(e)),r(e=>({...e,comments:t(e.comments)}))}catch(t){const e=t instanceof Error?t.message:"Failed to delete comment";throw m(e),t}},[n.postId]),k=a.useCallback(()=>{const e=t=>{let s=1;return t.replies&&(s+=t.replies.reduce((t,s)=>t+e(s),0)),s};return l.reduce((t,s)=>t+e(s),0)},[l]),w=a.useCallback(e=>{const t=s=>{for(const a of s){if(a.id===e)return a;if(a.replies){const e=t(a.replies);if(e)return e}}};return t(l)},[l]);return{modal:n,comments:l,isLoading:o,error:d,openModal:f,closeModal:b,addComment:j,editComment:y,deleteComment:v,loadComments:x,refreshComments:g,getCommentCount:k,getCommentById:w,clearError:h}},U=()=>{const[e,t]=a.useState(new Map),s=a.useCallback((e,s,a)=>{t(t=>{const n=new Map(t);return n.set(e,{isLiked:s,likeCount:a,isLoading:!1}),n})},[]),n=a.useCallback(t=>e.get(t)||null,[e]),r=a.useCallback(async e=>{try{const t=await fetch(`/api/posts/${e}/like-status`);if(t.ok){const a=await t.json();s(e,a.isLiked,a.likeCount)}}catch(t){}},[s]),l=a.useCallback(async(e,s,a)=>{t(t=>{const n=new Map(t);return n.set(e,{isLiked:s,likeCount:a,isLoading:!0}),n});const n=!s,r=n?a+1:a-1;t(t=>{const s=new Map(t);return s.set(e,{isLiked:n,likeCount:r,isLoading:!0}),s});try{const s=await fetch(`/api/posts/${e}/like`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error("Failed to toggle like");const a=await s.json();t(t=>{const s=new Map(t);return s.set(e,{isLiked:a.isLiked,likeCount:a.likeCount,isLoading:!1}),s})}catch(l){throw t(t=>{const n=new Map(t);return n.set(e,{isLiked:s,likeCount:a,isLoading:!1}),n}),l}},[]);return{likeStates:e,toggleLike:l,setLikeState:s,getLikeState:n,fetchLikeStatus:r}},D=()=>{const[e,t]=a.useState(!1),[s,n]=a.useState(null);return{isOpen:e,postId:s,openModal:a.useCallback(e=>{n(e),t(!0)},[]),closeModal:a.useCallback(()=>{t(!1),setTimeout(()=>{n(null)},300)},[])}};export{$ as C,N as P,U as a,D as b,R as c,C as d,z as e,A as u};
